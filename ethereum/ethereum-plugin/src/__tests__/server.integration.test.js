import { getBalance, getIsForwarderContract, isForwarderContract } from '@exodus/ethereum-api'
import { runEvmServerTestSuite } from '@exodus/ethereum-api/src/__tests__/server.testsuite.js'

import assetPlugin from '../index.js'

describe(`ethereum server integration tests`, () => {
  const walletAddress = '0x1e7dCC21013C060B091040f6C3eb70a6221DB3b7'
  const contractAddress = '0xf75e354c5edc8efed9b59ee9f67a80845ade7d0c'

  const { server, asset } = runEvmServerTestSuite({ assetPlugin, walletAddress, contractAddress })

  describe('isForwarderContract with fallback', () => {
    test('isContract on forwarder contract returns is-a-contract', async () => {
      const isContract = await isForwarderContract({
        asset,
        address: '0x831662be961c9851a7cd43cde074ca0cff385949',
      })
      expect(isContract).toBeTruthy()
    })

    test('isContract on forwarder contract returns is-a-contract using lru memoize', async () => {
      const params = {
        asset,
        address: '0x831662be961c9851a7cd43cde074ca0cff385949',
      }
      const isContract1 = await getIsForwarderContract(params)
      const isContract2 = await getIsForwarderContract(params)
      expect(isContract1).toBeTruthy()
      expect(isContract2).toBeTruthy()
      expect(isContract1).toEqual(isContract2)
    })

    test('isContract on other contract returns not-a-contract', async () => {
      const isContract = await isForwarderContract({
        asset,
        address: '0xd35e6f3b26f8992a7f023ad878e13a82dded2232',
      })
      expect(isContract).toBeFalsy()
    })

    test('isContract on ordinary address returns not-a-contract', async () => {
      const isContract = await isForwarderContract({
        asset,
        address: '0x7c71f5b89389b504dad3b50ed77f360706022ba6',
      })
      expect(isContract).toBeFalsy()
    })
  })

  describe('sendRawTransaction', () => {
    test('Invalid RLP', async () => {
      expect.assertions(1)
      try {
        await server.sendRawTransaction('0000')
      } catch (err) {
        expect(err.message).toMatch(/transaction type not supported/)
      }
    }, 20_000)

    test('Only replay protected transactions allowed', async () => {
      expect.assertions(1)
      try {
        await server.sendRawTransaction(
          'f864808506fc23ac0082520894ed32d62e940c7de772d6c8aea226f94b46f1483c80801ca06937e96f1a907b99f8fde65abebb363b6674b33dd357885233393ad8052fbdd2a0388a05206b979765924d842d6118bba87efe9a47f99fb8ba66d0865ee0d16185'
        )
      } catch (err) {
        expect(err.message).toMatch(
          /only replay-protected \(EIP-155\) transactions allowed over RPC/
        )
      }
    })

    test.skip('Insufficient funds', async () => {
      expect.assertions(1)
      try {
        await server.sendRawTransaction(
          'f870028082520894a520ca9a99e3da0faa656ff5c0ea0756a69be58c91ffffffffffffffffffffffffffffffffff8025a070215f44f4251ea773ca462ecbaf60c397363f770fbeab8dc8528f244b76c48ea02ab2c889bb178092bd05aa13c74349a4a151997a9020557ca87ac60425eff3c9'
        )
      } catch (err) {
        expect(err.message).toMatch(/insufficient funds for gas \* price \+ value/)
      }
    }, 20_000)

    // If the gas goes down again, this test may fail with the `insufficient funds for gas` error.
    // Revisit both tests with higher and lower gas so integration tests are more robust.
    test('Transaction underprice', async () => {
      expect.assertions(1)
      try {
        // {
        //   "chainId": "1",
        //   "type": "LegacyTransaction",
        //   "valid": true,
        //   "hash": "0x600aefe955a76f463bb624488e60ed2785da4a215d7f16b67754c93426c1c2bd",
        //   "nonce": "2",
        //   "gasPrice": "0",
        //   "gasLimit": "21000",
        //   "from": "0xa520cA9A99e3DA0FAa656ff5c0Ea0756a69bE58c",
        //   "to": "0xa520ca9a99e3da0faa656ff5c0ea0756a69be58c",
        //   "v": "25",
        //   "r": "70215f44f4251ea773ca462ecbaf60c397363f770fbeab8dc8528f244b76c48e",
        //   "s": "2ab2c889bb178092bd05aa13c74349a4a151997a9020557ca87ac60425eff3c9",
        //   "value": "87112285931760246646623899502532662132735"
        // }
        await server.sendRawTransaction(
          'f870028082520894a520ca9a99e3da0faa656ff5c0ea0756a69be58c91ffffffffffffffffffffffffffffffffff8025a070215f44f4251ea773ca462ecbaf60c397363f770fbeab8dc8528f244b76c48ea02ab2c889bb178092bd05aa13c74349a4a151997a9020557ca87ac60425eff3c9'
        )
      } catch (err) {
        expect(err.message).toMatch(/transaction gas price below minimum/)
      }
    }, 20_000)
  })

  describe('ethCall', () => {
    test('erc20 call returns response', async () => {
      // `balanceOf()` call to Augur (REP) contract.
      const result = await server.ethCall({
        from: '0x7758d79c8fa4747a44577b8780ed8534d5e1945f',
        to: '0x1985365e9f78359a9b6ad760e32412f4a445e862',
        amount: '0x0',
        data: '0x70a082310000000000000000000000007758d79c8fa4747a44577b8780ed8534d5e1945f',
      })
      // This test will fail if the balance ever changes
      expect(result).toEqual('0x0000000000000000000000000000000000000000000000000000000000000000')
    })
  })

  describe('getBalance', () => {
    test('0x7c71f5b89389b504dad3b50ed77f360706022ba6', async () => {
      const balance = await server.getBalance('0x7c71f5b89389b504dad3b50ed77f360706022ba6')
      expect(balance).toBe('0x0')
    })

    test('proxied eth_getBalance works', async () => {
      const address = '0x06a65beafc02635bf85aa2fc3b86a7f236c0ae9d' // just a random address
      const balance = await server.getBalanceProxied(address, 'latest')
      expect(balance.startsWith('0x')).toBeTruthy()
    })

    test('0x7c71f5b89389b504dad3b50ed77f360706022ba6 with fallback', async () => {
      const balance = await getBalance({
        asset,
        address: '0x7c71f5b89389b504dad3b50ed77f360706022ba6',
      })
      expect(typeof balance).toEqual('string')
    })
  })

  describe('getHistory', () => {
    test('empty list', async () => {
      const list = await server.getAllTransactions({
        address: '0xde0b295669a9fd93d5f28d9ec85e40f4cb697bab',
      })
      expect(list).toEqual({
        transactions: {
          pending: [],
          confirmed: [],
        },
        cursor: Buffer.from([0, 45, 49, 1, 0, 0, 0, 0]),
      })
    })

    test('return history', async () => {
      const expected = [
        {
          blockNumber: 282_892,
          effects: [],
          error: null,
          extraData: {},
          from: '0xfe78b27b9a135636679f07fbccca7cabd8e5c370',
          gas: '90000',
          gasPrice: '50000000000',
          gasPriceEffective: '50000000000',
          gasUsed: '43597',
          gasUsedCumulative: '43597',
          hash: '0x467bebe971601dc4ab900fb7199668085686c766bb52cbe044fcd5271ed981a4',
          input: '0x432ced044861736852656700000000000000000000000000000000000000000000000000',
          methodId: '0x432ced04',
          nonce: '2',
          status: null,
          timestamp: '0x14fff0a8e30',
          to: '0x33990122638b9132ca29c723bdf037f1a891a70c',
          transactionIndex: '0',
          type: '0x0',
          value: '0',
          walletChanges: [],
        },
        {
          blockNumber: 282_892,
          type: '0x0',
          hash: '0x5236c351f1c5095962012e71352a7286e37802f367f1d39a89ef2df0a89f25af',
          transactionIndex: '2',
          nonce: '3',
          gas: '90000',
          gasPrice: '50000000000',
          gasPriceEffective: '50000000000',
          gasUsed: '67010',
          gasUsedCumulative: '131607',
          to: '0x33990122638b9132ca29c723bdf037f1a891a70c',
          from: '0xfe78b27b9a135636679f07fbccca7cabd8e5c370',
          timestamp: '0x14fff0a8e32',
          value: '0',
          status: null,
          error: null,
          effects: [],
          input:
            '0xbe99a980486173685265670000000000000000000000000000000000000000000000000000000000000000000000000023bf622b5a65f6060d855fca401133ded35206200000000000000000000000000000000000000000000000000000000000000001',
          methodId: '0xbe99a980',
          walletChanges: [],
          extraData: {},
        },
      ]
      let {
        transactions: { confirmed },
      } = await server.getAllTransactions({
        address: '0x33990122638b9132ca29c723bdf037f1a891a70c',
        cursor: null,
      })

      confirmed.map((item) => expect(item.confirmations).toBeGreaterThanOrEqual(0))

      confirmed = confirmed.slice(1, 3).map((item) => {
        // confirmations number isn't constant so we need to delete it
        // eslint-disable-next-line @exodus/mutable/no-param-reassign-prop-only
        delete item.confirmations
        return item
      })

      for (const [i, element] of confirmed.entries()) {
        expect(element).toEqual(expected.at(i))
      }
    })
  })

  describe('proxy to coin node', () => {
    // Getting, please fix Error: insufficient funds for gas * price + value: address 0xc4F28E9D9EcA931064257cb82B3f53f32ae4eFE6 have 78758023954548561 want 62243276779800000000
    test.skip('long data field should work', async () => {
      const callResult = await server.proxyToCoinNode({
        method: 'eth_call',
        params: [
          {
            from: '0xc4F28E9D9EcA931064257cb82B3f53f32ae4eFE6',
            to: '0x1f98415757620b543a52e61c46b32eb19261f984',
            data: '0x1749e1e30000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004e00000000000000000000000000000000000000000000000000000000000009c00000000000000000000000000000000000000000000000000000000000000a800000000000000000000000000000000000000000000000000000000000000b400000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000cc00000000000000000000000000000000000000000000000000000000000000d600000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000ea00000000000000000000000000000000000000000000000000000000000000f400000000000000000000000000000000000000000000000000000000000000fe00000000000000000000000000000000000000000000000000000000000001080000000000000000000000000000000000000000000000000000000000000114000000000000000000000000000000000000000000000000000000000000011e00000000000000000000000000000000000000000000000000000000000001280000000000000000000000000000000000000000000000000000000000000132000000000000000000000000000000000000000000000000000000000000013c00000000000000000000000000000000000000000000000000000000000001460000000000000000000000000000000000000000000000000000000000000150000000000000000000000000000000000000000000000000000000000000015a0000000000000000000000000000000000000000000000000000000000000164000000000000000000000000000000000000000000000000000000000000016e00000000000000000000000000000000000000000000000000000000000001780000000000000000000000000000000000000000000000000000000000000182000000000000000000000000000000000000000000000000000000000000018c000000000000000000000000000000000000000000000000000000000000019600000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001aa00000000000000000000000000000000000000000000000000000000000001b400000000000000000000000000000000000000000000000000000000000001be00000000000000000000000000000000000000000000000000000000000001c800000000000000000000000000000000000000000000000000000000000001d200000000000000000000000000000000000000000000000000000000000001dc00000000000000000000000000000000000000000000000000000000000001e600000000000000000000000000000000000000000000000000000000000001f000000000000000000000000000000000000000000000000000000000000001fa0000000000000000000000000000000000000000000000000000000000000204000000000000000000000000000000000000000000000000000000000000020e00000000000000000000000000000000000000000000000000000000000002180000000000000000000000000000000000000000000000000000000000000222000000000000000000000000000000000000000000000000000000000000022c00000000000000000000000000000000000000000000000000000000000002360000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000024a0000000000000000000000000000000000000000000000000000000000000254000000000000000000000000000000000000000000000000000000000000025e00000000000000000000000000000000000000000000000000000000000002680000000000000000000000000000000000000000000000000000000000000272000000000000000000000000000000000000000000000000000000000000027c00000000000000000000000000000000000000000000000000000000000002860000000000000000000000000000000000000000000000000000000000000290000000000000000000000000000000000000000000000000000000000000029a00000000000000000000000000000000000000000000000000000000000002a400000000000000000000000000000000000000000000000000000000000002ae00000000000000000000000000000000000000000000000000000000000002b800000000000000000000000000000000000000000000000000000000000002c200000000000000000000000000000000000000000000000000000000000002cc00000000000000000000000000000000000000000000000000000000000002d600000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000002ea00000000000000000000000000000000000000000000000000000000000002f400000000000000000000000000000000000000000000000000000000000002fe00000000000000000000000000000000000000000000000000000000000003080000000000000000000000000000000000000000000000000000000000000312000000000000000000000000000000000000000000000000000000000000031c00000000000000000000000000000000000000000000000000000000000003260000000000000000000000000000000000000000000000000000000000000330000000000000000000000000000000000000000000000000000000000000033a0000000000000000000000000000000000000000000000000000000000000344000000000000000000000000000000000000000000000000000000000000034e00000000000000000000000000000000000000000000000000000000000003580000000000000000000000000000000000000000000000000000000000000362000000000000000000000000000000000000000000000000000000000000036c00000000000000000000000000000000000000000000000000000000000003760000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000038a0000000000000000000000000000000000000000000000000000000000000394000000000000000000000000000000000000000000000000000000000000039e00000000000000000000000000000000000000000000000000000000000003aa000000000000000000000000000000000000c2e074ec69a0dfb2997ba6c7d2e1e00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000240178b8bf00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c2e074ec69a0dfb2997ba6c7d2e1e00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000240178b8bf4c26a3429695964eec70f1aa137a97a767066e57db4f9ca325652b9004e7cf740000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c2e074ec69a0dfb2997ba6c7d2e1e00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000240178b8bfbee1f2e40ee121df128b41442104fdf816c46059e8faa71cc2e425fe5251f26b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c2e074ec69a0dfb2997ba6c7d2e1e00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000240178b8bfd4b63be5dc653a81f793311d472893a9fba1cf21a22bde8747ebf6af4a89cb9100000000000000000000000000000000000000000000000000000000000000000000000000000000004375dff511095cc5a197a54140a24efef3a41600000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000040902f1ac000000000000000000000000000000000000000000000000000000000000000000000000000000000de0fa91b6dbab8c8503aaa2d1dfa91a192cb14900000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000040902f1ac000000000000000000000000000000000000000000000000000000000000000000000000000000000d4a11d5eeaac28ec3f61d100daf4d40471f185200000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000040902f1ac0000000000000000000000000000000000000000000000000000000000000000000000000000000011b815efb8f581194ae79006d24e0d814b7697f600000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a6865020000000000000000000000000000000000000000000000000000000000000000000000000000000011b815efb8f581194ae79006d24e0d814b7697f600000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000001f98415757620b543a52e61c46b32eb19261f98400000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000040f28c97d000000000000000000000000000000000000000000000000000000000000000000000000000000001f98415757620b543a52e61c46b32eb19261f98400000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000244d2301cc000000000000000000000000c4f28e9d9eca931064257cb82b3f53f32ae4efe600000000000000000000000000000000000000000000000000000000000000000000000000000000231b7589426ffe1b75405526fc32ac09d44364c400000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000040902f1ac000000000000000000000000000000000000000000000000000000000000000000000000000000003041cbd36888becc7bbcbc0045e3b1f144466f5f00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000040902f1ac000000000000000000000000000000000000000000000000000000000000000000000000000000003196f48548c3b8c901bc4cc5ad662ba97c9c0b2b00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000003196f48548c3b8c901bc4cc5ad662ba97c9c0b2b00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd00000000000000000000000000000000000000000000000000000000000000000000000000000000391e8501b626c623d39474afca6f9e46c268664900000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a68650200000000000000000000000000000000000000000000000000000000000000000000000000000000391e8501b626c623d39474afca6f9e46c268664900000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000004585fe77225b41b697c938b018e2ac67ac5a20c000000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000004585fe77225b41b697c938b018e2ac67ac5a20c000000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000004773e2c1c0b400a16dfec4ca6e305141859a554200000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000004773e2c1c0b400a16dfec4ca6e305141859a554200000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000004e68ccd3e89f51c3074ca5072bbac773960dfa3600000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000004e68ccd3e89f51c3074ca5072bbac773960dfa3600000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd0000000000000000000000000000000000000000000000000000000000000000000000000000000056534741cd8b152df6d48adf7ac51f75169a83b200000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a6865020000000000000000000000000000000000000000000000000000000000000000000000000000000056534741cd8b152df6d48adf7ac51f75169a83b200000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000005a59e4e647a3acc42b01715f3a1d271c1f7e7aeb00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000005a59e4e647a3acc42b01715f3a1d271c1f7e7aeb00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd0000000000000000000000000000000000000000000000000000000000000000000000000000000060594a405d53811d3bc4766596efd80fd545a27000000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a6865020000000000000000000000000000000000000000000000000000000000000000000000000000000060594a405d53811d3bc4766596efd80fd545a27000000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd00000000000000000000000000000000000000000000000000000000000000000000000000000000649caaf37f36e67d1129c0fd6c6539d390ca2b8200000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a68650200000000000000000000000000000000000000000000000000000000000000000000000000000000649caaf37f36e67d1129c0fd6c6539d390ca2b8200000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000006958686b6348c3d6d5f2dca3106a5c09c156873a00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000006958686b6348c3d6d5f2dca3106a5c09c156873a00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000006ab3bba2f41e7eaa262fa5a1a9b3932fa161526f00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000006ab3bba2f41e7eaa262fa5a1a9b3932fa161526f00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000006c6bc977e13df9b0de53b251522280bb7238370000000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000006c6bc977e13df9b0de53b251522280bb7238370000000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000006f48eca74b38d2936b02ab603ff4e36a6c0e3a7700000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000006f48eca74b38d2936b02ab603ff4e36a6c0e3a7700000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000007858e59e0c01ea06df3af3d20ac7b0003275d4bf00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000007858e59e0c01ea06df3af3d20ac7b0003275d4bf00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000007bea39867e4169dbe237d55c8242a8f2fcdcc38700000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000007bea39867e4169dbe237d55c8242a8f2fcdcc38700000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd0000000000000000000000000000000000000000000000000000000000000000000000000000000088e6a0c2ddd26feeb64f039a2c41296fcb3f564000000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a6865020000000000000000000000000000000000000000000000000000000000000000000000000000000088e6a0c2ddd26feeb64f039a2c41296fcb3f564000000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000008ad599c3a0ff1de082011efddc58f1908eb6e6d800000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000008ad599c3a0ff1de082011efddc58f1908eb6e6d800000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd0000000000000000000000000000000000000000000000000000000000000000000000000000000099ac8ca7087fa4a2a1fb6357269965a2014abc3500000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a6865020000000000000000000000000000000000000000000000000000000000000000000000000000000099ac8ca7087fa4a2a1fb6357269965a2014abc3500000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000009db9e0e53058c89e5b94e29621a205198648425b00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000009db9e0e53058c89e5b94e29621a205198648425b00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd000000000000000000000000000000000000000000000000000000000000000000000000000000009a772018fbd77fcd2d25657e5c547baff3fd7d1600000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a686502000000000000000000000000000000000000000000000000000000000000000000000000000000009a772018fbd77fcd2d25657e5c547baff3fd7d1600000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd00000000000000000000000000000000000000000000000000000000000000000000000000000000a478c2975ab1ea89e8196811f51a7b7ade33eb1100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000040902f1ac00000000000000000000000000000000000000000000000000000000000000000000000000000000a93eb5b410b651514a18724872306f5ce9928dde00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a68650200000000000000000000000000000000000000000000000000000000000000000000000000000000a93eb5b410b651514a18724872306f5ce9928dde00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd00000000000000000000000000000000000000000000000000000000000000000000000000000000ae461ca67b15dc8dc81ce7615e0320da1a9ab8d500000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000040902f1ac00000000000000000000000000000000000000000000000000000000000000000000000000000000b20bd5d04be54f870d5c0d3ca85d82b34b83640500000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000040902f1ac00000000000000000000000000000000000000000000000000000000000000000000000000000000b4e16d0168e52d35cacd2c6185b44281ec28c9dc00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000040902f1ac00000000000000000000000000000000000000000000000000000000000000000000000000000000bb2b8038a1640196fbe3e38816f3e67cba72d94000000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000040902f1ac00000000000000000000000000000000000000000000000000000000000000000000000000000000c2e9f25be6257c210d7adf0d4cd6e3e881ba25f800000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a68650200000000000000000000000000000000000000000000000000000000000000000000000000000000c2e9f25be6257c210d7adf0d4cd6e3e881ba25f800000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd00000000000000000000000000000000000000000000000000000000000000000000000000000000c5af84701f98fa483ece78af83f11b6c38aca71d00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a68650200000000000000000000000000000000000000000000000000000000000000000000000000000000c5af84701f98fa483ece78af83f11b6c38aca71d00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd00000000000000000000000000000000000000000000000000000000000000000000000000000000cbcdf9626bc03e24f779434178a73a0b4bad62ed00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a68650200000000000000000000000000000000000000000000000000000000000000000000000000000000cbcdf9626bc03e24f779434178a73a0b4bad62ed00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd00000000000000000000000000000000000000000000000000000000000000000000000000000000cbfb0745b8489973bf7b334d54fdbd573df7ef3c00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a68650200000000000000000000000000000000000000000000000000000000000000000000000000000000cbfb0745b8489973bf7b334d54fdbd573df7ef3c00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd00000000000000000000000000000000000000000000000000000000000000000000000000000000ee4cf3b78a74affa38c6a926282bcd8b5952818d00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a68650200000000000000000000000000000000000000000000000000000000000000000000000000000000ee4cf3b78a74affa38c6a926282bcd8b5952818d00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd00000000000000000000000000000000000000000000000000000000000000000000000000000000a63b490aa077f541c9d64bfc1cc0db2a752157b500000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a68650200000000000000000000000000000000000000000000000000000000000000000000000000000000a63b490aa077f541c9d64bfc1cc0db2a752157b500000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd00000000000000000000000000000000000000000000000000000000000000000000000000000000a80964c5bbd1a0e95777094420555fead1a26c1e00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a68650200000000000000000000000000000000000000000000000000000000000000000000000000000000a80964c5bbd1a0e95777094420555fead1a26c1e00000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd00000000000000000000000000000000000000000000000000000000000000000000000000000000bb256c2f1b677e27118b0345fd2b3894d2e6d48700000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000041a68650200000000000000000000000000000000000000000000000000000000000000000000000000000000bb256c2f1b677e27118b0345fd2b3894d2e6d48700000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000043850c7bd0000000000000000000000000000000000000000000000000000000000000000000000000000000065770b5283117639760bea3f867b69b3697a91dd000000000000000000000000000000000000000000000000000000000002d2a80000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000002470a08231000000000000000000000000c4f28e9d9eca931064257cb82b3f53f32ae4efe6000000000000000000000000000000000000000000000000000000000000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000000000000000000000000000000000000002d2a80000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000002470a08231000000000000000000000000c4f28e9d9eca931064257cb82b3f53f32ae4efe600000000000000000000000000000000000000000000000000000000',
          },
          '0xe46027',
        ],
      })
      expect(callResult).toMatch(/^0x[\da-f]+$/)
    })

    test('request with no params should work', async () => {
      const priceRaw = await server.proxyToCoinNode({ method: 'eth_gasPrice' })
      expect(priceRaw).toMatch(/^0x[\da-f]+$/)
    })

    test('coin node should return error if method doesn not exist', async () => {
      try {
        await server.proxyToCoinNode({ method: 'eth_unknown' })
      } catch (e) {
        expect(e.message.includes('Unsupported Method')).toBeTruthy()
      }
    })
  })
})
